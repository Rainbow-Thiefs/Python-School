- [Вступление](#%d0%92%d1%81%d1%82%d1%83%d0%bf%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5)
- [Что из себя представляет база данных](#%d0%a7%d1%82%d0%be-%d0%b8%d0%b7-%d1%81%d0%b5%d0%b1%d1%8f-%d0%bf%d1%80%d0%b5%d0%b4%d1%81%d1%82%d0%b0%d0%b2%d0%bb%d1%8f%d0%b5%d1%82-%d0%b1%d0%b0%d0%b7%d0%b0-%d0%b4%d0%b0%d0%bd%d0%bd%d1%8b%d1%85)
  - [Правила Кодда](#%d0%9f%d1%80%d0%b0%d0%b2%d0%b8%d0%bb%d0%b0-%d0%9a%d0%be%d0%b4%d0%b4%d0%b0)
  - [Нормализация БД и нормальные формы](#%d0%9d%d0%be%d1%80%d0%bc%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%91%d0%94-%d0%b8-%d0%bd%d0%be%d1%80%d0%bc%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b5-%d1%84%d0%be%d1%80%d0%bc%d1%8b)
- [Установка Postgresql](#%d0%a3%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0-postgresql)
- [Подключение к БД через консоль (cli)](#%d0%9f%d0%be%d0%b4%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%ba-%d0%91%d0%94-%d1%87%d0%b5%d1%80%d0%b5%d0%b7-%d0%ba%d0%be%d0%bd%d1%81%d0%be%d0%bb%d1%8c-cli)
  - [Необходимо осмотреться](#%d0%9d%d0%b5%d0%be%d0%b1%d1%85%d0%be%d0%b4%d0%b8%d0%bc%d0%be-%d0%be%d1%81%d0%bc%d0%be%d1%82%d1%80%d0%b5%d1%82%d1%8c%d1%81%d1%8f)
  - [Работа со справкой и полезные команды](#%d0%a0%d0%b0%d0%b1%d0%be%d1%82%d0%b0-%d1%81%d0%be-%d1%81%d0%bf%d1%80%d0%b0%d0%b2%d0%ba%d0%be%d0%b9-%d0%b8-%d0%bf%d0%be%d0%bb%d0%b5%d0%b7%d0%bd%d1%8b%d0%b5-%d0%ba%d0%be%d0%bc%d0%b0%d0%bd%d0%b4%d1%8b)
- [Использование pg_admin](#%d0%98%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-pgadmin)
- [Управление ролями (пользователями)](#%d0%a3%d0%bf%d1%80%d0%b0%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5-%d1%80%d0%be%d0%bb%d1%8f%d0%bc%d0%b8-%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d1%82%d0%b5%d0%bb%d1%8f%d0%bc%d0%b8)
  - [Создание роли (пользователя)](#%d0%a1%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%80%d0%be%d0%bb%d0%b8-%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d1%82%d0%b5%d0%bb%d1%8f)
  - [Назначение прав роли](#%d0%9d%d0%b0%d0%b7%d0%bd%d0%b0%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d1%80%d0%b0%d0%b2-%d1%80%d0%be%d0%bb%d0%b8)
- [Создание БД](#%d0%a1%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%91%d0%94)
- [Проектирование БД](#%d0%9f%d1%80%d0%be%d0%b5%d0%ba%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%91%d0%94)
- [Создание резервных копий и восстановление БД](#%d0%a1%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%80%d0%b5%d0%b7%d0%b5%d1%80%d0%b2%d0%bd%d1%8b%d1%85-%d0%ba%d0%be%d0%bf%d0%b8%d0%b9-%d0%b8-%d0%b2%d0%be%d1%81%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5-%d0%91%d0%94)
  - [pg_dump](#pgdump)
- [Связи таблиц](#%d0%a1%d0%b2%d1%8f%d0%b7%d0%b8-%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86)
  - [Отношения между таблицами](#%d0%9e%d1%82%d0%bd%d0%be%d1%88%d0%b5%d0%bd%d0%b8%d1%8f-%d0%bc%d0%b5%d0%b6%d0%b4%d1%83-%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0%d0%bc%d0%b8)
  - [Типы данных](#%d0%a2%d0%b8%d0%bf%d1%8b-%d0%b4%d0%b0%d0%bd%d0%bd%d1%8b%d1%85)
- [Полезные ссылки](#%d0%9f%d0%be%d0%bb%d0%b5%d0%b7%d0%bd%d1%8b%d0%b5-%d1%81%d1%81%d1%8b%d0%bb%d0%ba%d0%b8)


# Вступление
PostgreSQL одна из самых популярных баз данных, обладает прекрасным быстродействием, максимальной поддержкой стандарта SQL, является Open Source проектом (проектом с открытым исходным кодом), что предполагает бесплатное использование в коммерческих проектах.
Также, обладает поддержкой огромного числа типов данных, в том числе, на волне популярности NoSQL, с недавних пор обзавелась поддержкой JSON.

У PostgreSQL отличная официальная документация, не следует ей пренебрегать.

- [Официльная документация](https://postgrespro.ru/docs/postgresql)
- [Официальный сайт Postgre](https://www.postgresql.org/)
- [Больше информации о PostgreSQL на WiKi](https://ru.wikipedia.org/wiki/PostgreSQL)

# Что из себя представляет база данных
База данных - это комплексное понятие, которое в себя включает:
- Сервер базы данных
- Клиент для подключения к серверу баз данных
- Базы данных
- Схема(ы) базы данных
- Данные, хранимые в базе(ах) данных

Сервер баз данных - это классическое клиент-серверное приложение. Для работы с базой данных необходим сервер БД, а также клиент, с помощью которого осуществляется подключение к БД. Сервер баз данных позволяет обслуживать одновременно несколько баз данных, поэтому, часто сервер баз данных называют кластером баз данных.

Помимо стандартного консольного клиента БД, в различных языках существуют свои реализации клиентов.

К примеру, в языке python для подключения и работы с Postgres имеется модуль [psycopg2](https://pypi.org/project/psycopg2/).
Модуль представляет из себя компилируемые исходники, поэтоу, чтобы упростить установку модуля, можно установить уже готовй модуль:
```bash
pip install psycopg2-binary
```

Также, клиенты БД в различных языках часто называют драйверами БД.

Сервер баз данных позволяет создавать, хранить и управлять базами данных, а также манипулировать самими данными. Т.е. на одном сервере, может храниться несколько баз данных. В свою очередь, базы данных состоят из таблиц, которые связаны между собой логически. Связи (отношения/relations) между таблицами и дали название базам данных - реляционные. К реляционным базам данных относятся следующие БД: MySQL, Oracle, MS SQL (список неполный).

Стоит отметить, что помимо реаляционных баз данных (работа с которыми осуществляется посредством языка запросов SQL) существуют, так называемые, NoSQL базы данных: MongoDB, Aerospike, Cassandrf, DocumentDB (aws) и т.д.

Таблицы представляют из себя набор полей (столбцов) и строк (кортежей).

id|UserName|Email|Role
:-|:-|:-|:-
1|Zeus|zeus@mail.org|admin
2|Athena|a.thena@mail.org|user
3|Hermes|her.mes@mail.net|user

Описание всех таблиц, полей (имена полей и типы полей), всего что касается конкретной базы данных, называют Схемой Базы Данных.
[!NOTE] Схема базы данных - это её структура, но ни в коем случае не сами данные.

Для упрощения построения и понимания схем БД создают ERD - Entity Relation Diagram (диаграмма отношения между сущностями).
Фактически, ERD является чертежом для создания схемы БД.

Существует класс как платных, так и бесплатных редакторов для построения ERD. Ниже перечислены некоторые беслпатные (условно бесплатные редакторы ERD):
- [https://online.visual-paradigm.com](https://online.visual-paradigm.com)
- [https://www.visual-paradigm.com](https://www.visual-paradigm.com)

## Правила Кодда
Существует 12 правил Кодда, которым должна соответствовать реляционная БД:
1. Правило 0: Основное правило (Foundation Rule):
    Система, которая рекламируется или позиционируется как реляционная система управления базами данных, должна быть способна управлять базами данных, используя исключительно свои реляционные возможности.
1. Правило 1: Информационное правило (The Information Rule):
    Вся информация в реляционной базе данных на логическом уровне должна быть явно представлена единственным способом: значениями в таблицах.
1. Правило 2: Гарантированный доступ к данным (Guaranteed Access Rule):
    В реляционной базе данных каждое отдельное (атомарное) значение данных должно быть логически доступно с помощью комбинации имени таблицы, значения первичного ключа и имени столбца.
1. Правило 3: Систематическая поддержка отсутствующих значений (Systematic Treatment of Null Values):
    Неизвестные, или отсутствующие значения NULL, отличные от любого известного значения, должны поддерживаться для всех типов данных при выполнении любых операций. Например, для числовых данных неизвестные значения не должны рассматриваться как нули, а для символьных данных — как пустые строки.
1. Правило 4: Доступ к словарю данных в терминах реляционной модели (Active On-Line Catalog Based on the Relational Model):
    Словарь данных должен сохраняться в форме реляционных таблиц, и СУБД должна поддерживать доступ к нему при помощи стандартных языковых средств, тех же самых, которые используются для работы с реляционными таблицами, содержащими пользовательские данные.
1. Правило 5: Полнота подмножества языка (Comprehensive Data Sublanguage Rule):
    Система управления реляционными базами данных должна поддерживать хотя бы один реляционный язык, который
       - (а) имеет линейный синтаксис,
       - (б) может использоваться как интерактивно, так и в прикладных программах,
       - (в) поддерживает операции определения данных, определения представлений, манипулирования данными (интерактивные и программные), ограничители целостности, управления доступом и операции управления транзакциями (begin, commit и rollback).
1. Правило 6: Возможность изменения представлений (View Updating Rule):
    Каждое представление должно поддерживать все операции манипулирования данными, которые поддерживают реляционные таблицы: операции выборки, вставки, изменения и удаления данных.
1. Правило 7: Наличие высокоуровневых операций управления данными (High-Level Insert, Update, and Delete):
    Операции вставки, изменения и удаления данных должны поддерживаться не только по отношению к одной строке реляционной таблицы, но и по отношению к любому множеству строк.
1. Правило 8: Физическая независимость данных (Physical Data Independence):
    Приложения не должны зависеть от используемых способов хранения данных на носителях, от аппаратного обеспечения компьютеров, на которых находится реляционная база данных.
1. Правило 9: Логическая независимость данных (Logical Data Independence):
    Представление данных в приложении не должно зависеть от структуры реляционных таблиц. Если в процессе нормализации одна реляционная таблица разделяется на две, представление должно обеспечить объединение этих данных, чтобы изменение структуры реляционных таблиц не сказывалось на работе приложений.
1. Правило 10: Независимость контроля целостности (Integrity Independence):
    Вся информация, необходимая для поддержания целостности, должна находиться в словаре данных. Язык для работы с данными должен выполнять проверку входных данных и автоматически поддерживать целостность данных.
1. Правило 11: Независимость от расположения (Distribution Independence):
    База данных может быть распределённой, может находиться на нескольких компьютерах, и это не должно оказывать влияния на приложения. Перенос базы данных на другой компьютер не должен оказывать влияния на приложения.
1. Правило 12: Согласование языковых уровней (The Nonsubversion Rule):
    Если используется низкоуровневый язык доступа к данным, он не должен игнорировать правила безопасности и правила целостности, которые поддерживаются языком более высокого уровня.

[Данные взяты из WiKi](https://ru.wikipedia.org/wiki/12_%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB_%D0%9A%D0%BE%D0%B4%D0%B4%D0%B0)

## Нормализация БД и нормальные формы
Нормализация представляет процесс разделения данных по отдельным связанным таблицам. Нормализация устраняет избыточность данных (data redundancy) и тем самым позволяет избежать нарушения целостности данных при их изменении, то есть избежать аномалий изменения (update anomaly).

Как правило, нормализация преимущественно применяется при восходящем подходе проектирования базы данных, то есть когда мы все атрибуты, которые надо сохранить в бд, группируем по сущностям, для которых затем создаются таблицы. Однако при нисходящем подходе, когда вначале выявляются сущности, а затем их атрибуты и связи между ними, нормализация также может применяться, например, для проверки корректности спроектированных таблиц.

В ненормализованной форме таблица может хранить информацию о двух и более сущностях. Также она может содержать повторяющиеся столбцы. Также столбцы могут хранить повторяющиеся значения. В нормализованной же форме каждая таблица хранит информацию только об одной сущности.

Нормализация предполагает применение нормальных форм к структуре данных. Существуют 7 нормальных форм. Каждая нормальная форма (за исключением первой) подразумевает, что к данным уже была применена предыдущая нормальная форма. Например, прежде чем применить третью нормальную форму к данным должна быть применена вторая нормальная форма. И строго говоря, база данных считается нормализованной, если к ней применяется третья нормальная форма и выше.

Первая нормальная форма (1NF) предполагает, что сохраняемые данные на пересечении строк и столбцов должны представлять скалярное значение, а таблицы не должны содержать повторяющихся строк.

Вторая нормальная форма (2NF) предполагает, что каждый столбец, не являющийся ключом, должен зависеть от первичного ключа.

Третья нормальная форма (3NF) предполагает, что каждый столбец, не являющийся ключом, должен зависеть только от первичного ключа.

Нормальная форма Бойса-Кодда (BCNF) является немного более строгой версией третьей нормальной формы.

Четвертая нормальная форма (4NF) применяется для устранения многозначных зависимостей (multivalued dependencies) - таких зависимостей, где столбец с первичным ключом имеет связь один-ко-многим со столбцом, который не является ключом. Эта нормальная форма устраняет некорректные отношения многие-ко-многим.

Пятая нормальная форма (5NF) разделяет таблицы на более малые таблицы для устранения избыточности данных. Разбиение идет до тех пор, пока нельзя будет воссоздать оригинальную таблицу путем объединения малых таблиц.

Шестая нормальная форма (domain key normal form / 6NF). Каждое ограничение в связях между таблицами должно зависеть только от ограничений ключа и ограничений домена, где домен представляет набор допустимых значений для столбца. Эта форма предотвращает добавление недопустимых данных путем установки ограничения на уровне отношений между таблицами, но не на уровне таблиц или столбцов. Данная форма, как правило, не применима на уровне СУБД, в том числе и в SQL Server.
- [Нормальные формы Metanin](https://metanit.com/sql/tutorial/2.1.php)
- [Нормальные формы Habr](https://habr.com/ru/post/254773/)

# Установка Postgresql

# Подключение к БД через консоль (cli)
После установки, чтобы подключиться к серверу базы данных необходимо воспользоваться командой:
```bash
sudo -u postgres psql
```
Т.о. производится подключение от имени пользователя postgres, который создаётся как в ОС так и является суперпользователем (пользователем с максимальными правами) в самой БД.
В данном случае, будет запрошен пароль текущего пользователя, для повышения прав. Логично, что у пользователя должны быть соответствующие права в sudoers.

Также, подключиться к БД можно и другими способами.
Способ 1: используя URI формат начиная с версии PostgreSQL 9.2
```bash
psql postgresql://myuser:mypasswd@myhost:5432/mydb
```
- psql - консольный клиент для подключения к БД
- mydb - имя БД
- myhost - адрес сервера (dns или ip-адрес)

Способ 2: используя параметры psql
```bash
psql -U my_user -d mydb -h myhost
```
Если параметры подключения не указаны явно, то Postgres попытается взять эти данные из соответствующих переменных окружения:
- PGHOST or PGHOSTADDR
- PGPORT (стандартный порт 5432)
- PGDATABASE
- PGUSER
- PGPASSWORD (крайне не рекомендуется хранить пароль в переменной окружения)

## Необходимо осмотреться
После успешного подключения, необходимо осмотреться - понять какая версия Postgres используется, под каким пользователем мы вошли в БД, узнать адрес сервера, порт и т.д.

SQL-запрос|Описание
:---|:---
SELECT current_user;|Показать текущего пользователя
SELECT current_database();| Показать текущую БД
SELECT version();| Версия БД
SELECT inet_server_addr();|Адрес сервера БД
SELECT inet_server_port();|Порт сервера БД

[!NOTE] Каждый SQL должен завершаться точкой с запятой - **;**

## Работа со справкой и полезные команды
Помимо запросов, консоль Postgres предоставляет множество полезных команд. Перечислим самые часто используемые.

[PATTERN] - если шаблон отсутствует, будут выведены все данные, щесли же указан - только те данные, которые соответствуют шаблону.

"+" - если сразу после команды указать +, к примеру \du+ - будет выведено дополнительное поле Description (описание).

Команды|Описание
:-|:-
\\?| получить полный список всех команд
\h|получить список всех SQL операторов
\q|выход из консоли psql
\l|вывод списка баз данных
\c[connect] [DBNAME]|подключиться к конкретной базе данных {[DBNAME|- USER|- HOST|- PORT|-] | conninfo}
\d|вывод списка таблиц БД, views, sequences
\d NAME|вывод описания полей таблицы, view, index, sequence
\dg или \du [PATTERN]|вывести список ролей
\di [PATTERN]|вывести индекс
\dt [PATTERN]|вывести список таблиц
\conninfo|вывести информацию о подключении
\password [USERNAME]|изменить пароль для пользователя USERNAME


# Использование pg_admin


# Управление ролями (пользователями)
Наличие нескольких пользователей на сервере БД позволяет гибко настраивать права на различные базы данных, а также на отдельные таблицы. Это позволяет как повысить безопасность данных в целом, а так же избежать ошибочных действий как со стороны пользователей так и приложений.

После установки сервера PostgreSQL, по умолчанию в системе создаётся пользователь (супер пользователь БД) с полными правами на сервер БД - *postgres*.

Имена пользователей базы данных PostgreSQL не имеют прямой связи с пользователями операционной системы на которой запущен сервер. Если у всех пользователей базы данных заведена учётная запись в операционной системе сервера, то имеет смысл назначить им точно такие же имена для входа в PostgreSQL. Однако, сервер, принимающий удалённые подключения, может иметь большое количество пользователей базы данных, у которых нет учётной записи в ОС. В таких случаях не требуется соответствие между именами пользователей базы данных и именами пользователей операционной системы.

PostgreSQL использует концепцию ролей (roles) для управления разрешениями на доступ к базе данных. Роль можно рассматривать как пользователя базы данных или как группу пользователей, в зависимости от того, как роль настроена. Роли могут владеть объектами базы данных (например, таблицами и функциями) и выдавать другим ролям разрешения на доступ к этим объектам, управляя тем, кто имеет доступ и к каким объектам. Кроме того, можно предоставить одной роли членство в другой роли, таким образом одна роль может использовать права других ролей.

Концепция ролей включает в себя концепцию пользователей («users») и групп («groups»). До версии 8.1 в PostgreSQL пользователи и группы были отдельными сущностями, но теперь есть только роли. Любая роль может использоваться в качестве пользователя, группы, и того и другого.

## Создание роли (пользователя)
Итак, база данных установлена. Что дальше? Как подключиться к базе данных? Какого пользователя использовать для работы с БД?

Роли можно создавать и удалять с помощью SQL-запросов, а также, с помощью специальных утилит [createuser](https://postgrespro.ru/docs/postgresql/9.6/app-createuser) и [dropuser](https://postgrespro.ru/docs/postgresql/9.6/app-dropuser).

Лишь суперпользователь и пользователи с привилегией CREATEROLE могут создавать новые роли, таким образом, соответствующий SQL-запрос или createuser должны запускаться от их лица.

Чтобы создать дополнительного суперпользователя, необходимо подключиться от имени существующего суперпользователя, одного лишь права CREATEROLE недостаточно. Поскольку суперпользователи могут обходить все ограничения доступа в базе данных, к назначению этих полномочий не следует относиться легкомысленно.

[Атрибуты ролей](https://postgrespro.ru/docs/postgresql/9.6/role-attributes) определяют возможности ролей. К примеру, роль с атрибутом LOGIN, можно рассматривать как пользователя БД, данный атрибут обеспечивает возможность интерактивно подключаться к БД. Атрибут SUPERUSER позволит получить роли права суперпользователя/суперроли.

```sql
CREATE ROLE role_with_login WITH CREATEDB LOGIN;
ALTER ROLE role_with_login WITH SUPERUSER;
```
Аналогично с помощью createuser:
```bash
createuser -l -s -d role_name
createuser --interactive role_name # интерактивное создание пользователя
```

Выше, мы создали роль с правами создания новых БД, а также с возможностью интерактивного входа в консоль БД. Далее, с помощью команды `ALTER ROLE` добавили права суперпользователя.

## Назначение прав роли
[Назначение прав](https://postgrespro.ru/docs/postgresql/12/ddl-priv) несложная задача. Во-первых, можно сделать владельцем БД некоторого пользователя, для этого используется следующий запрос:
```sql
ALTER TABLE имя_таблицы OWNER TO новый_владелец;
```
Также, мы можем выдать для объекта набор прав с помощью команды `GRANT` следующим образом:
```sql
GRANT UPDATE ON имя_таблицы TO имя_роли; # выдать права на обновление данных в таблице
GRANT ALL ON имя_таблицы TO имя_роли; # выдать все права на таблицу
GRANT ALL ON ALL TABLES TO имя_роли; # выдать все права на все таблицы в текующей БД:w
GRANT ALL PRIVILEGES ON DATABASE mydatabase TO myrole;
```
Для того, чтобы забрать права у роли, используется команда `REVOKE`.

Подробнее о [GRANT](https://postgrespro.ru/docs/postgresql/12/sql-grant), [REVOKE](https://postgrespro.ru/docs/postgresql/12/sql-revoke).

Основные типы прав: SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER, CREATE, CONNECT, TEMPORARY, EXECUTE и USAGE.

Особые права владельца объекта (то есть права на выполнение DROP, GRANT, REVOKE и т. д.) всегда неявно закреплены за владельцем и их нельзя назначить или отобрать. Но владелец объекта может лишить себя обычных прав, например, разрешить всем, включая себя, только чтение таблицы.

Обычно распоряжаться правами может только владелец объекта (или суперпользователь). Однако возможно дать право доступа к объекту «с правом передачи», что позволит получившему такое право назначать его другим. Если такое право передачи впоследствии будет отозвано, то все, кто получил данное право доступа (непосредственно или по цепочке передачи), потеряют его.

# Создание БД

# Проектирование БД
Проектирование БД может оказать сложной задачей, даже относительно простой интернет-магазин может содержать достаточно большое количество таблиц и связей в БД.

# Создание резервных копий и восстановление БД
## pg_dump

# Связи таблиц
## Отношения между таблицами
## Типы данных

# Полезные ссылки
- [Работа с PostgreSQL](https://postgresql.leopard.in.ua/)
- [Возможности PostgreSQL, которых нет в MySQL, и наоборот](https://habr.com/en/post/268631/)